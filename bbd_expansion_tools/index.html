<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>笔笔达工具</title>
</head>
<body>
  <h3>登录</h3>
  <input type="text" id="account" placeholder="手机号">
  <input type="password" id="password" placeholder="密码">
  <button id="login"">登录</button>
  <p id="login-msg" style="color: #f00"></p>
  <h3>功能</h3>
  <button id="export-register-list">导出申请注册商户列表</button>
</body>
<script>
  window.onload = function() {
    let msgBox = document.getElementById('login-msg');
    //渲染当前登录信息
    msgBox.innerText = cookie.get('loginMsg') ? cookie.get('loginMsg') : '当前未登录';
    
    let loginBtn = document.getElementById('login');
    //登录
    loginBtn.onclick = function() {
      login();
    }

    let exportRegisterList = document.getElementById('export-register-list');
    //导出申请注册商户列表
    exportRegisterList.onclick = function() {
      merchantRegister.getTotalPage(res => {
        merchantRegister.getRegisterList(res);
      });
    }
  }

  //封装cookie操作
  const cookie = {
    //设置cookie
    set: function(key, value, exHours) {
      let text = `${key}=${value};`;
      if (exHours && typeof exHours == 'number') {
        let d = new Date();
        d.setTime(d.getTime() + (exHours * 60 * 60 * 1000));
        let expires = `expires=${d.toGMTString()}`;
        text = text + expires;
      }
      document.cookie = text;
      return text;
    },

    //读取cookie
    get: function(key) {
      let list = document.cookie.split(/;|=|\s/);
      for (let i = 0; i < list.length; i++) {
        if (list[i] == key) {
          return list[i + 1];
        }
      }
    },

    //删除cookie
    del: function(key) {
      let text = `${key}=;expires=Thu, 01 Jan 1970 00:00:00 GMT`;
      document.cookie = text;
      return text;
    }
  }

  //商户申请注册
  const merchantRegister = {
    //获取申请注册列表
    getRegisterList: function(totalPage, oldData) {
      ajax({
        type: 'post',
        url: 'https://api.mhbbd.com/bibida/web/regapply/list',
        data: `{"beginTime": null, "city": null, "county": null, "endTime": null, "mobile": null, "pageNo": ${totalPage}, "pageSize": 100, "province": null}`
      }, res => {
        let data = JSON.parse(res).result.list;

        if (!oldData) {
          oldData = [];
        }

        let newData = oldData.concat(data);
        
        if(totalPage > 0) {
          this.getRegisterList(totalPage-1, newData);
        } else {
          var csvData = 'id,name,mobile,storename,province,city,county,address,createTime,updateTime,';
          for (let i = 0; i < oldData.length; i++) {
            csvData += '\r\n';
            for (let item in oldData[i]) {
              csvData += `${oldData[i][item]},`;
            }
          }
          exportCsv('export.csv', csvData);
        }
      });
    },
    //获取申请注册列表页数
    getTotalPage: function(callBack) {
      ajax({
        type: 'post',
        url: 'https://api.mhbbd.com/bibida/web/regapply/list',
        data: `{"beginTime": null, "city": null, "county": null, "endTime": null, "mobile": null, "pageNo": 1, "pageSize": 100, "province": null}`
      }, res => {
        let totalPage = JSON.parse(res).result.totalPage;
        callBack(totalPage);
      });
    },
  }

  //ajax
  function ajax(options, res) {
    let xhr = new XMLHttpRequest();
    xhr.open(options.type, options.url);
    if (cookie.get('token')) {
      xhr.setRequestHeader('token', cookie.get('token'));
    }
    xhr.setRequestHeader('Content-Type', "application/json; charset=utf-8");
    if(options.data) {
      xhr.send(options.data);
    } else {
      xhr.send();
    }
    xhr.onload = function() {
        res(xhr.responseText);
    }
  }

  //登录
  function login() {
    let account = document.getElementById('account').value;
    let password = document.getElementById('password').value;
    ajax({
      type: 'post',
      url: 'https://api.mhbbd.com/bibida/login/login',
      data: `{"account": "${account}", "passWord": "${password}"}`
    }, res => {
      let data = JSON.parse(res);
      let msgBox = document.getElementById('login-msg');
      if (data.success && data.success == true) {
        msgBox.innerText = `登录成功，当前用户：${data.result.userName}`;
      } else {
        msgBox.innerText = '登录失败，手机号或密码不正确';
      }
      cookie.set('token', data.result.token);
      cookie.set('loginMsg', `登录成功，当前用户：${data.result.userName}`);
    });
  }

  //导出csv
  function exportCsv(fileName, text) {
    let link = document.createElement('a');
    link.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
    link.setAttribute('download', fileName);
    link.style.display = 'none';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }
  
</script>
</html>
